class UI{constructor(e,t,n,i,s,a,o,l){if(e instanceof UI&&(this.parent=e,this.parent.children.push(this)),this.relX=t,this.relY=n,this.width=i,this.height=s,a instanceof Function&&(this.renderFunc=a),a instanceof Array){let e=a[0],t=a[1],n=a[2];this.isInput=!0,this.value="",this.clickFunc=function(){textInput.value=this.value,t?textInput.maxLength=t:textInput.removeAttribute("maxlength"),textInput.focus(),UI.focusedInput=this,o instanceof Function&&o.call(this,UI.focusedInput===this)},this.textCanvas=createBuffer(this.width,this.height),this.renderFunc=function(t){t.input(e)},n&&(this.enterFunc=n)}else this.clickFunc=o,this.isInput=!1;this.children=[],this.showing=void 0===l||l,this.parent||UI.elements.push(this)}getX(){return this.parent?this.parent.getX()+this.relX:this.relX}getY(){return this.parent?this.parent.getY()+this.relY:this.relY}render(){if(this.showing)if(translate(this.relX,this.relY),this.renderFunc&&this.renderFunc(this.schematics()),1===this.children.length)this.children[0].render();else for(let e of this.children)push(),e.render(),pop()}schematics(){let e={};return e.fullRect=(()=>{rect(0,0,this.width,this.height)}),e.button=((t,n,i,s)=>{noStroke(),n&&(fill(COLORS.UI.buttonBox),e.fullRect()),this.isHovered()&&(fill(COLORS.UI.buttonHover),e.fullRect()),s?fill(COLORS.UI.greyText):fill(COLORS.UI.text),textAlign(CENTER,CENTER),textSize(i||18),text(t,this.width/2,this.height/2)}),e.input=(t=>{fill(COLORS.UI.input),UI.focusedInput===this?stroke(COLORS.UI.text):(this.isHovered()&&(noStroke(),e.fullRect(),fill(COLORS.UI.buttonHover)),stroke(COLORS.UI.nonSelectedInput)),e.fullRect();let n=this.textCanvas;n.clear(),n.noStroke(),n.fill(COLORS.UI.text),n.textSize(t||18);let i,s=UI.focusedInput===this?textInput.value:this.value;if(UI.focusedInput===this){n.textAlign(LEFT,CENTER);let e=n.textWidth(s.slice(0,textInput.selectionStart)),t=n.textWidth(s.slice(0,textInput.selectionEnd));e+=i=t>this.width-5?this.width-5-t:5,t+=i,n.text(s,i,this.height/2),textInput.selectionStart===textInput.selectionEnd?(n.stroke(COLORS.UI.text),n.noFill(),millis()%1e3<500&&n.line(e,this.height/8,e,7*this.height/8)):(n.rect(e,this.height/8,t-e,3*this.height/4),n.fill(COLORS.UI.input),n.text(s.slice(textInput.selectionStart,textInput.selectionEnd),e,this.height/2))}else n.textWidth(s)>this.width-5?(n.textAlign(RIGHT,CENTER),i=this.width-5):(n.textAlign(LEFT,CENTER),i=5),n.text(s,i,this.height/2);image(n,0,0)}),e}setBox(e,t,n,i){void 0===e&&(e=this.relX),void 0===t&&(t=this.relY),void 0===n&&(n=this.width),void 0===i&&(i=this.height),translate(e-this.relX,t-this.relY),this.relX=e,this.relY=t,this.width=n,this.height=i}append(e,...t){return!1!==e&&this.children.length>e?this.children[e].append(0,...t):new UI(this,...t)}checkMouseOver(){if(this.showing){if(this.children.length>0){let e=null;for(let t=this.children.length-1;t>=0;t--)if(e=this.children[t].checkMouseOver())return e}let e=this.getX(),t=e+this.width,n=this.getY(),i=n+this.height;if(this.clickFunc&&getMouseX()>=e&&getMouseX()<t&&getMouseY()>=n&&getMouseY()<i)return this}return null}isHovered(){return UI.mouseOver===this}clicked(){this.clickFunc instanceof Function&&this.clickFunc()}show(){this.showing=!0}hide(){this.showing=!1}toggleShow(){this.showing=!this.showing}remove(){let e=!1;if(this.checkMouseOver()&&(UI.mouseOver=void 0,e=!0),this.parent){for(let e=this.parent.children.length-1;e>=0;e--)if(this.parent.children[e]===this){this.parent.children.splice(e,1);break}}else for(let e=UI.elements.length-1;e>=0;e--)if(UI.elements[e]===this){UI.elements.splice(e,1);break}e&&UI.updateMouseOver()}dropChildren(){let e=!1;this.checkMouseOver()&&(UI.mouseOver=void 0,e=!0),this.children=[],e&&UI.updateMouseOver()}}function mouseInCanvas(){return coordinateInCanvas(getMouseX(),getMouseY())}function mouseClicked(){if(mouseInCanvas()&&waitingFor<1)return UI.click(),!1}function selectStorm(e){e instanceof Storm?(selectedStorm=e,stormInfoPanel.target=e):selectedStorm=void 0}function keyPressed(){if(document.activeElement!==textInput){switch(keyRepeatFrameCounter=-1,key){case" ":UI.viewBasin&&primaryWrapper.showing&&(paused=!paused);break;case"a":UI.viewBasin&&paused&&primaryWrapper.showing&&UI.viewBasin.advanceSim();break;case"w":simSettings.setShowStrength("toggle");break;case"e":UI.viewBasin&&UI.viewBasin.env.displayNext();break;case"t":simSettings.setTrackMode("incmod",4),refreshTracks(!0);break;case"m":simSettings.setShowMagGlass("toggle"),UI.viewBasin&&UI.viewBasin.env.updateMagGlass();break;default:switch(keyCode){case KEY_LEFT_BRACKET:simSpeed++,simSpeed>5&&(simSpeed=5);break;case KEY_RIGHT_BRACKET:simSpeed--,simSpeed<0&&(simSpeed=0);break;case KEY_F11:toggleFullscreen();break;default:return}}return!1}if(keyCode===ESCAPE)return textInput.value=UI.focusedInput.value,textInput.blur(),!1;if(keyCode===ENTER){let e=UI.focusedInput;return textInput.blur(),e.enterFunc&&e.enterFunc(),!1}}function changeViewTick(e){let t=UI.viewBasin.getSeason(viewTick);viewTick=e;let n=UI.viewBasin.getSeason(viewTick),i=()=>{refreshTracks(t!==n),UI.viewBasin.env.displayLayer()},s=e=>{let t=[],n=!0;for(let i=0;i<e.systems.length;i++){let s=e.systems[i];s instanceof StormRef&&(void 0===s.lastApplicableAt||s.lastApplicableAt>=viewTick||2===simSettings.trackMode)&&(t.push(s.season),n=n&&UI.viewBasin.fetchSeason(s.season))}if(n)i();else{for(let e=0;e<t.length;e++)t[e]=UI.viewBasin.fetchSeason(t[e],!1,!1,!0);Promise.all(t).then(i)}};UI.viewBasin.fetchSeason(viewTick,!0)?s(UI.viewBasin.fetchSeason(viewTick,!0)):UI.viewBasin.fetchSeason(viewTick,!0,!1,e=>{s(e)})}function deviceTurned(){toggleFullscreen()}function wrapText(e,t){let n="";for(let i=0,s=0;i<e.length;i=s){if("\n"===e.charAt(i)){i++,s++,n+="\n";continue}-1===(s=e.indexOf("\n",i))&&(s=e.length);let a=e.slice(i,s);for(;textWidth(a)>t;){let e=0;for(;textWidth(a.slice(0,e))<=t;)e++;if(--e<1){n+=a.charAt(0)+"\n",a=a.slice(1);continue}let i=a.lastIndexOf(" ",e-1);if(-1!==i){n+=a.slice(0,i)+"\n",a=a.slice(i+1);continue}let s=a.slice(0,e);-1===(i=s.search(/\W(?=\w*$)/))?(n+=s+"\n",a=a.slice(e)):(n+=a.slice(0,i+1)+"\n",a=a.slice(i+1))}n+=a}return n}function countTextLines(e){let t=1;for(let n=0;n<e.length;n++)"\n"===e.charAt(n)&&t++;return t}function ktsToMph(e,t){let n=1.15078*e;return t&&(n=round(n/t)*t),n}function ktsToKmh(e,t){let n=1.852*e;return t&&(n=round(n/t)*t),n}function oneMinToTenMin(e,t){let n=7*e/8;return t&&(n=round(n/t)*t),n}function mbToInHg(e,t){let n=.02953*e;return t&&(n=round(n/t)*t),n}function damageDisplayNumber(e){return 0===e?"none":e<5e7?"minimal":e<1e9?"$ "+round(e/1e3)/1e3+" M":e<1e12?"$ "+round(e/1e6)/1e3+" B":"$ "+round(e/1e9)/1e3+" T"}function formatDate(e){if(e instanceof moment){const t="HH[z] MMM DD";let n,i=e.format(t),s=e.year();return s<1&&(s=1-s,n=!0),i+=" "+zeroPad(s,4),n&&(i+=" B.C.E."),i}}function seasonName(e,t){void 0===t&&(t=UI.viewBasin instanceof Basin&&UI.viewBasin.SHem);let n="",i=e=>e<1?1-e:e;const s=" B.C.E.";return t?(n+=zeroPad(i(e-1),4),1===e&&(n+=s),n+="-"+zeroPad(i(e)%100,2),e<1&&(n+=s),n):(n+=zeroPad(i(e),4),e<1&&(n+=s),n)}UI.elements=[],UI.renderAll=function(){for(let e of UI.elements)push(),e.render(),pop()},UI.mouseOver=void 0,UI.focusedInput=void 0,UI.updateMouseOver=function(){for(let e=UI.elements.length-1;e>=0;e--){let t=UI.elements[e].checkMouseOver();if(t)return UI.mouseOver=t,t}return UI.mouseOver=null,null},UI.click=function(){return UI.updateMouseOver(),!!UI.mouseOver&&(UI.mouseOver.clicked(),!0)},UI.viewBasin=void 0,UI.init=function(){let e;mainMenu=new UI(null,0,0,WIDTH,HEIGHT),basinCreationMenu=new UI(null,0,0,WIDTH,HEIGHT,void 0,function(){e.enterFunc()},!1),loadMenu=new UI(null,0,0,WIDTH,HEIGHT,void 0,void 0,!1),settingsMenu=new UI(null,0,0,WIDTH,HEIGHT,void 0,void 0,!1),primaryWrapper=new UI(null,0,0,WIDTH,HEIGHT,function(e){if(UI.viewBasin instanceof Basin){let e=UI.viewBasin;if(e.viewingPresent())for(let t of e.activeSystems)t.fetchStorm().renderIcon();else{let t=e.fetchSeason(viewTick,!0);if(t)for(let e of t.forSystems(!0))e.renderIcon()}if(!land.drawn)return void(renderToDo=land.draw());let t=()=>{if(simSettings.showMagGlass){let e=buffers.get(magnifyingGlass);image(magnifyingGlass,getMouseX()-e.baseWidth/2,getMouseY()-e.baseHeight/2,e.baseWidth,e.baseHeight)}};drawBuffer(outBasinBuffer),e.env.displaying>=0&&e.env.layerIsOceanic&&(drawBuffer(envLayer),t()),drawBuffer(landBuffer),simSettings.snowLayers&&(land.snowDrawn?drawBuffer(snow[floor(map(seasonalSine(viewTick,SNOW_SEASON_OFFSET),-1,1,0,10*simSettings.snowLayers))]):renderToDo=land.drawSnow()),simSettings.useShader&&(land.shaderDrawn?drawBuffer(landShader):renderToDo=land.drawShader()),e.env.displaying>=0&&!e.env.layerIsOceanic&&(drawBuffer(envLayer),t(),e.env.layerIsVector||drawBuffer(coastLine)),drawBuffer(tracks),drawBuffer(forecastTracks),drawBuffer(stormIcons)}},function(){if(helpBox.hide(),sideMenu.hide(),seedBox.hide(),UI.viewBasin instanceof Basin){let e=UI.viewBasin;if(e.godMode&&keyIsPressed&&e.viewingPresent()){let t={x:getMouseX(),y:getMouseY()};if("l"===key||"L"===key)t.sType="l";else if("d"===key)t.sType="d";else if("D"===key)t.sType="sd";else if("s"===key)t.sType="s";else if("S"===key)t.sType="ss";else if("1"===key)t.sType="1";else if("2"===key)t.sType="2";else if("3"===key)t.sType="3";else if("4"===key)t.sType="4";else if("5"===key)t.sType="5";else if("6"===key)t.sType="6";else if("7"===key)t.sType="7";else if("8"===key)t.sType="8";else if("9"===key)t.sType="9";else if("0"===key)t.sType="10";else if("y"===key||"Y"===key)t.sType="y";else{if("x"!==key&&"X"!==key)return;t.sType="x"}e.spawn(!1,t)}else if(e.viewingPresent()){let t=createVector(getMouseX(),getMouseY());for(let n=e.activeSystems.length-1;n>=0;n--){let i=e.activeSystems[n].fetchStorm();if(i.getStormDataByTick(viewTick,!0).pos.dist(t)<DIAMETER)return selectStorm(i),void refreshTracks(!0)}selectStorm(),refreshTracks(!0)}else{let t=e.fetchSeason(viewTick,!0);if(t){let e=createVector(getMouseX(),getMouseY());for(let n=t.systems.length-1;n>=0;n--){let i=t.fetchSystemAtIndex(n);if(i&&i.aliveAt(viewTick)){if(i.getStormDataByTick(viewTick).pos.dist(e)<DIAMETER)return selectStorm(i),void refreshTracks(!0)}}selectStorm(),refreshTracks(!0)}}}},!1),areYouSure=new UI(null,0,0,WIDTH,HEIGHT,function(e){fill(COLORS.UI.box),noStroke(),e.fullRect()},!0,!1),mainMenu.append(!1,WIDTH/2,HEIGHT/4,0,0,function(e){fill(COLORS.UI.text),noStroke(),textAlign(CENTER,CENTER),textSize(36),text(TITLE,0,0),textSize(16),textStyle(NORMAL),text("I don't know what I'm doing I pretty much just took PB's fork and screw around with numbers till I'm bored...",0,50),text("I suck at code and computers in general :<",0,75);}),mainMenu.append(!1,WIDTH/2-100,HEIGHT/2-20,200,40,function(e){e.button("New Basin",!0,24)},function(){mainMenu.hide(),basinCreationMenu.show()}).append(!1,0,60,200,40,function(e){e.button("Load Basin",!0,24)},function(){mainMenu.hide(),loadMenu.show(),loadMenu.refresh()}).append(!1,0,60,200,40,function(e){e.button("Settings",!0,24)},function(){mainMenu.hide(),settingsMenu.show()}),basinCreationMenu.append(!1,WIDTH/2,HEIGHT/16,0,0,function(e){fill(COLORS.UI.text),noStroke(),textAlign(CENTER,CENTER),textSize(36),text("New Basin Settings",0,0)});let t=basinCreationMenu.append(!1,WIDTH/2-200,HEIGHT/8,400,28,function(e){let t="Random";1===newBasinSettings.hem&&(t="Northern"),2===newBasinSettings.hem&&(t="Southern"),e.button("Hemisphere: "+t,!0)},function(){e.enterFunc(),void 0===newBasinSettings.hem?newBasinSettings.hem=1:(newBasinSettings.hem++,newBasinSettings.hem%=3)}).append(!1,0,36,0,28,function(e){textAlign(LEFT,CENTER),text("Starting year: ",0,14)});t.append(!1,110,0,290,28,function(e){let t;if(void 0===newBasinSettings.year)t="Current year";else{let e,n=newBasinSettings.year;1===newBasinSettings.hem&&(e=!1),2===newBasinSettings.hem&&(e=!0),t=void 0===e?seasonName(n,!1)+" or "+seasonName(n,!0):seasonName(n,e)}textAlign(LEFT,CENTER);let n=18;for(textSize(n);textWidth(t)>this.width-10&&n>8;)n--,textSize(n);e.button(t,!0,n)},function(){e.toggleShow(),e.showing&&e.clicked()}),e=t.append(!1,110,0,290,28,[18,16,function(){if(e.showing){let t=e.value,n=t.match(/^\s*(\d+)(\s+B\.?C\.?(?:E\.?)?)?(?:\s*-\s*(\d+))?(?:\s+(?:(B\.?C\.?(?:E\.?)?)|A\.?D\.?|C\.?E\.?))?\s*$/i);if(n){let e,t=n[2]||n[4],i=n[4],s=parseInt(n[1]);t&&(s=1-s),n[3]?(e=parseInt(n[3]),i&&(e=1-e),newBasinSettings.year=s+1===e||(s+1)%100===e?s+1:void 0):newBasinSettings.year=s}else""!==t&&(newBasinSettings.year=void 0);newBasinSettings.year&&!moment.utc([newBasinSettings.year,0,1]).isValid()&&(newBasinSettings.year=void 0),e.value="",e.hide()}}],void 0,!1);let n=t.append(!1,0,36,400,28,function(e){let t=newBasinSettings.actMode||0;t=SIMULATION_MODES[t],e.button("Simulation Mode: "+t,!0)},function(){e.enterFunc(),void 0===newBasinSettings.actMode&&(newBasinSettings.actMode=0),newBasinSettings.actMode++,newBasinSettings.actMode%=SIMULATION_MODES.length}).append(!1,0,36,400,28,function(e){let t=newBasinSettings.scale||0;t=Scale.presetScales[t].displayName,e.button("Scale: "+t,!0)},function(){e.enterFunc(),void 0===newBasinSettings.scale&&(newBasinSettings.scale=0),newBasinSettings.scale++,newBasinSettings.scale%=Scale.presetScales.length,newBasinSettings.scaleFlavor=0,newBasinSettings.scaleColorScheme=0}).append(!1,0,36,400,28,function(e){let t=newBasinSettings.scale||0;t=Scale.presetScales[t];let n=newBasinSettings.scaleFlavor||0,i=t.flavorDisplayNames.length<2;e.button("Scale Flavor: "+(t.flavorDisplayNames[n]||"N/A"),!0,18,i)},function(){e.enterFunc();let t=newBasinSettings.scale||0;(t=Scale.presetScales[t]).flavorDisplayNames.length<2||(void 0===newBasinSettings.scaleFlavor&&(newBasinSettings.scaleFlavor=0),newBasinSettings.scaleFlavor++,newBasinSettings.scaleFlavor%=t.flavorDisplayNames.length)}).append(!1,0,36,400,28,function(e){let t=newBasinSettings.scale||0;t=Scale.presetScales[t];let n=newBasinSettings.scaleColorScheme||0,i=t.colorSchemeDisplayNames.length<2;e.button("Scale Color Scheme: "+(t.colorSchemeDisplayNames[n]||"N/A"),!0,18,i)},function(){e.enterFunc();let t=newBasinSettings.scale||0;(t=Scale.presetScales[t]).colorSchemeDisplayNames.length<2||(void 0===newBasinSettings.scaleColorScheme&&(newBasinSettings.scaleColorScheme=0),newBasinSettings.scaleColorScheme++,newBasinSettings.scaleColorScheme%=t.colorSchemeDisplayNames.length)}).append(!1,0,36,400,28,function(e){let t=newBasinSettings.designations||0;t=DesignationSystem.presetDesignationSystems[t].displayName,e.button("Designations: "+t,!0)},function(){e.enterFunc(),void 0===newBasinSettings.designations&&(newBasinSettings.designations=0),newBasinSettings.designations++,newBasinSettings.designations%=DesignationSystem.presetDesignationSystems.length}).append(!1,0,36,400,28,function(e){let t=["Two Continents","East Continent","West Continent","Island Ocean","Central Continent","Central Inland Sea","Atlantic","Eastern Pacific","Western Pacific","Northern Indian Ocean","Australian Region","South Pacific","South-West Indian Ocean","South Atlantic","Mediterranean"][newBasinSettings.mapType||0];e.button("Map Type: "+t,!0)},function(){e.enterFunc(),void 0===newBasinSettings.mapType&&(newBasinSettings.mapType=0),newBasinSettings.mapType++,newBasinSettings.mapType%=MAP_TYPES.length}).append(!1,0,36,400,28,function(e){let t=newBasinSettings.godMode?"Enabled":"Disabled";e.button("God Mode: "+t,!0)},function(){e.enterFunc(),newBasinSettings.godMode=!newBasinSettings.godMode}).append(!1,0,36,0,28,function(e){textAlign(LEFT,CENTER),text("Seed:",0,14)}).append(!1,50,0,350,28,[18,16],function(){e.enterFunc()});basinCreationMenu.append(!1,WIDTH/2-200,7*HEIGHT/8-20,400,28,function(e){e.button("Start",!0,20)},function(){e.enterFunc();let t=n.value;/^-?\d+$/g.test(t)?newBasinSettings.seed=parseInt(t):newBasinSettings.seed=hashCode(t),n.value="";let i={};1===newBasinSettings.hem?i.hem=!1:2===newBasinSettings.hem?i.hem=!0:i.hem=random()<.5,i.year=i.hem?SHEM_DEFAULT_YEAR:NHEM_DEFAULT_YEAR,void 0!==newBasinSettings.year&&(i.year=newBasinSettings.year);for(let e of["seed","actMode","designations","mapType","godMode","scale","scaleFlavor","scaleColorScheme"])i[e]=newBasinSettings[e];let s=new Basin(!1,i);newBasinSettings={},s.initialized.then(()=>{s.mount()}),basinCreationMenu.hide()}).append(!1,0,36,400,28,function(e){e.button("Cancel",!0,20)},function(){e.value="",e.hide(),basinCreationMenu.hide(),mainMenu.show()}),loadMenu.loadables=[],loadMenu.page=0,loadMenu.append(!1,WIDTH/2,HEIGHT/8,0,0,function(e){fill(COLORS.UI.text),noStroke(),textAlign(CENTER,CENTER),textSize(36),text("Load Basin",0,0)}),loadMenu.refresh=function(){loadMenu.loadables=[],waitForAsyncProcess(()=>db.transaction("r",db.saves,()=>{let e=db.saves.orderBy("format"),t=e.primaryKeys(),n=e.keys();return Promise.all([t,n])}).then(e=>{let t=e[0],n=e[1];for(let e=0;e<t.length;e++)loadMenu.loadables.push({saveName:t[e],format:n[e]});loadMenu.loadables.sort((e,t)=>(e=e.saveName,t=t.saveName,e===AUTOSAVE_SAVE_NAME?-1:t===AUTOSAVE_SAVE_NAME?1:e>t?1:-1))}),"Fetching Saved Basins...").catch(e=>{console.error(e)})};let i=function(e){let t,n,i=loadMenu.loadables[loadMenu.page*LOAD_MENU_BUTTONS_PER_PAGE+this.buttonNum];i?(t=i.saveName,i.format<EARLIEST_COMPATIBLE_FORMAT?(t+=" [Incompatible]",n=!1):n=!0):(t="--Empty--",n=!1);let s=18;for(textSize(s);textWidth(t)>this.width-10&&s>8;)s--,textSize(s);e.button(t,!0,s,!n)},s=function(){let e=loadMenu.loadables[loadMenu.page*LOAD_MENU_BUTTONS_PER_PAGE+this.buttonNum];if(e&&e.format>=EARLIEST_COMPATIBLE_FORMAT){let t=new Basin(e.saveName);t.initialized.then(()=>{t.mount()}),loadMenu.hide()}},a=[];for(let e=0;e<LOAD_MENU_BUTTONS_PER_PAGE;e++){let t=0===e?WIDTH/2-150:0,n=0===e?HEIGHT/4:40;a[e]=loadMenu.append(1,t,n,300,30,i,s),a[e].buttonNum=e}loadMenu.append(1,0,40,300,30,function(e){e.button("Cancel",!0,20)},function(){loadMenu.hide(),mainMenu.show()}),loadMenu.append(!1,WIDTH/2-75,HEIGHT/4-40,30,30,function(e){e.button("",!0,18,loadMenu.page<1),triangle(5,15,25,5,25,25)},function(){loadMenu.page>0&&loadMenu.page--}).append(!1,120,0,30,30,function(e){let t=loadMenu.page>=ceil(loadMenu.loadables.length/LOAD_MENU_BUTTONS_PER_PAGE)-1;e.button("",!0,18,t),triangle(5,5,25,15,5,25)},function(){loadMenu.page<ceil(loadMenu.loadables.length/LOAD_MENU_BUTTONS_PER_PAGE)-1&&loadMenu.page++});let o=function(e){let t=loadMenu.loadables[loadMenu.page*LOAD_MENU_BUTTONS_PER_PAGE+this.parent.buttonNum];e.button("Del",!0,18,!t)},l=function(){let e=loadMenu.loadables[loadMenu.page*LOAD_MENU_BUTTONS_PER_PAGE+this.parent.buttonNum];e&&areYouSure.dialog(()=>{Basin.deleteSave(e.saveName,()=>{loadMenu.refresh()})},'Delete "'+e.saveName+'"?')};for(let e=0;e<LOAD_MENU_BUTTONS_PER_PAGE;e++)a[e].append(!1,315,0,40,30,o,l);settingsMenu.append(!1,WIDTH/2,HEIGHT/8,0,0,function(e){fill(COLORS.UI.text),noStroke(),textAlign(CENTER,CENTER),textSize(36),text("Settings",0,0)}),settingsMenu.append(!1,WIDTH/2-150,HEIGHT/4,300,30,function(e){let t=simSettings.showStrength?"Enabled":"Disabled";e.button("Intensity Indicator: "+t,!0)},function(){simSettings.setShowStrength("toggle")}).append(!1,0,37,300,30,function(e){let t=simSettings.doAutosave?"Enabled":"Disabled";e.button("Autosaving: "+t,!0)},function(){simSettings.setDoAutosave("toggle")}).append(!1,0,37,300,30,function(e){let t=["Active TC Tracks","Full Active Tracks","Season Summary","No Tracks"][simSettings.trackMode];e.button("Track Mode: "+t,!0)},function(){simSettings.setTrackMode("incmod",4),refreshTracks(!0)}).append(!1,0,37,300,30,function(e){let t=simSettings.snowLayers?10*simSettings.snowLayers+" layers":"Disabled";e.button("Snow: "+t,!0)},function(){simSettings.setSnowLayers("incmod",floor(MAX_SNOW_LAYERS/10)+1),land&&land.clearSnow()}).append(!1,0,37,300,30,function(e){let t=simSettings.useShader?"Enabled":"Disabled";e.button("Land Shader: "+t,!0)},function(){simSettings.setUseShader("toggle")}).append(!1,0,37,300,30,function(e){let t=simSettings.showMagGlass?"Enabled":"Disabled";e.button("Magnifying Glass: "+t,!0)},function(){simSettings.setShowMagGlass("toggle"),UI.viewBasin&&UI.viewBasin.env.updateMagGlass()}).append(!1,0,37,300,30,function(e){let t=simSettings.smoothLandColor?"Enabled":"Disabled";e.button("Smooth Land Color: "+t,!0)},function(){simSettings.setSmoothLandColor("toggle"),land&&(landBuffer.clear(),land.drawn=!1)}),settingsMenu.append(!1,WIDTH/2-150,7*HEIGHT/8-20,300,30,function(e){e.button("Back",!0,20)},function(){settingsMenu.hide(),UI.viewBasin instanceof Basin?primaryWrapper.show():mainMenu.show()}),areYouSure.append(!1,WIDTH/2,HEIGHT/4,0,0,function(e){fill(COLORS.UI.text),noStroke(),textAlign(CENTER,CENTER),textSize(36),text("Are You Sure?",0,0),areYouSure.desc&&(textSize(24),text(areYouSure.desc,0,50))}),areYouSure.append(!1,WIDTH/2-108,HEIGHT/4+100,100,30,function(e){e.button("Yes",!0,20)},function(){areYouSure.action?(areYouSure.action(),areYouSure.action=void 0):console.error("No action tied to areYouSure dialog"),areYouSure.hide()}).append(!1,116,0,100,30,function(e){e.button("No",!0,20)},function(){areYouSure.hide()}),areYouSure.dialog=function(e,t){e instanceof Function&&(areYouSure.action=e,areYouSure.desc="string"==typeof t?t:void 0,areYouSure.show())};let r=primaryWrapper.append(!1,0,0,WIDTH,30,function(e){fill(COLORS.UI.bar),noStroke(),e.fullRect(),textSize(18)},!1);r.append(!1,5,3,100,24,function(e){if(!(UI.viewBasin instanceof Basin))return;let t=UI.viewBasin,n=formatDate(t.tickMoment(viewTick))+(t.viewingPresent()?"":" [Analysis]");this.setBox(void 0,void 0,textWidth(n)+6),this.isHovered()&&(fill(COLORS.UI.buttonHover),e.fullRect()),fill(COLORS.UI.text),textAlign(LEFT,TOP),text(n,3,3)},function(){dateNavigator.toggleShow()}),dateNavigator=primaryWrapper.append(!1,0,30,140,80,function(e){fill(COLORS.UI.box),noStroke(),e.fullRect(),fill(COLORS.UI.text),textAlign(LEFT,TOP),textSize(15),text("Y:",15,53)},!0,!1);let u=function(e){e.button("",!1,18,!paused),this.metadata%2==0?triangle(2,8,10,2,18,8):triangle(2,2,18,2,10,8)},c=function(){if(UI.viewBasin instanceof Basin&&paused){let e=UI.viewBasin,t=e.tickMoment(viewTick);switch(this.metadata){case 0:t.add(TICK_DURATION*ADVISORY_TICKS,"ms");break;case 1:t.subtract(TICK_DURATION*ADVISORY_TICKS,"ms");break;case 2:t.add(1,"M");break;case 3:t.subtract(1,"M");break;case 4:t.add(1,"d");break;case 5:t.subtract(1,"d");break;case 6:t.add(1,"y");break;case 7:t.subtract(1,"y")}let n=e.tickFromMoment(t);this.metadata%2==0&&n%ADVISORY_TICKS!=0&&(n=floor(n/ADVISORY_TICKS)*ADVISORY_TICKS),this.metadata%2!=0&&n%ADVISORY_TICKS!=0&&(n=ceil(n/ADVISORY_TICKS)*ADVISORY_TICKS),n>e.tick&&(n=e.tick),n<0&&(n=0),changeViewTick(n)}};for(let e=0;e<8;e++){let t=30*floor(e/2)+15,n=e%2==0?10:30;dateNavigator.append(!1,t,n,20,10,u,c).metadata=e}let d=dateNavigator.append(!1,30,50,70,20,[15,5,function(){if(!(UI.viewBasin instanceof Basin))return;let e=UI.viewBasin,t=this.value,n=parseInt(t);if(!Number.isNaN(n)&&paused){let t=e.tickMoment(viewTick);t.year(n);let i=e.tickFromMoment(t);i%ADVISORY_TICKS!=0&&(i=floor(i/ADVISORY_TICKS)*ADVISORY_TICKS),i>e.tick&&(i=e.tick),i<0&&(i=0),changeViewTick(i),this.value=""}}]);d.append(!1,80,0,20,20,function(e){let t,n=UI.focusedInput===d?textInput.value:d.value;Number.isNaN(parseInt(n))&&(t=!0),e.button("",!1,15,t),triangle(6,3,17,10,6,17),rect(2,8,4,4)},function(){d.enterFunc()}),r.append(!1,WIDTH-29,3,24,24,function(e){e.button(""),stormInfoPanel.showing?triangle(6,15,18,15,12,9):triangle(6,9,18,9,12,15)},function(){stormInfoPanel.showing||(stormInfoPanel.target=selectedStorm||UI.viewBasin.getSeason(viewTick)),stormInfoPanel.toggleShow()}).append(!1,-29,0,24,24,function(e){e.button(""),paused?triangle(3,3,21,12,3,21):(rect(5,3,5,18),rect(14,3,5,18))},function(){paused=!paused}).append(!1,-105,0,100,24,function(e){let t="";if(selectedStorm){let e=selectedStorm.getFullNameByTick(viewTick),n=selectedStorm.getStormDataByTick(viewTick);if(n){let i=n?n.windSpeed:0;t=e+": "+i+" kts, "+ktsToMph(i,WINDSPEED_ROUNDING)+" mph, "+ktsToKmh(i,WINDSPEED_ROUNDING)+" km/h / "+(n?n.pressure:1031)+" hPa"}else t=(e=selectedStorm.getFullNameByTick("peak"))+" - ACE: "+selectedStorm.ACE}else t=paused?"Paused":(0===simSpeed?"Full-":1===simSpeed?"Half-":"1/"+pow(2,simSpeed)+" ")+"Speed";let n=textWidth(t)+6;this.setBox(-n-5,void 0,n),this.isHovered()&&(fill(COLORS.UI.buttonHover),e.fullRect()),fill(COLORS.UI.text),textAlign(RIGHT,TOP),text(t,this.width-3,3)},function(){selectedStorm?(stormInfoPanel.target=selectedStorm,stormInfoPanel.show()):paused=!paused});let h=primaryWrapper.append(!1,0,HEIGHT-30,WIDTH,30,function(e){fill(COLORS.UI.bar),noStroke(),e.fullRect(),textSize(18)},!1);h.append(!1,5,3,24,24,function(e){e.button(""),rect(3,6,18,2),rect(3,11,18,2),rect(3,16,18,2)},function(){sideMenu.toggleShow(),saveBasinAsPanel.hide()}).append(!1,29,0,100,24,function(e){let t=UI.viewBasin,n="Map Layer: ",i=!1;if(-1!==t.env.displaying){let e,s,a=t.env.fieldList[t.env.displaying];n+=a+" -- ";let o=selectedStorm&&selectedStorm.aliveAt(viewTick);if(o){let t=selectedStorm.getStormDataByTick(viewTick,!0).pos;e=t.x,s=t.y}else e=getMouseX(),s=getMouseY();if(e>=WIDTH||e<0||s>=HEIGHT||s<0||t.env.fields[a].oceanic&&land.get(e,s))n+="N/A";else{let o=t.env.get(a,e,s,viewTick);if(null===o)n+="Unavailable",i=!0;else if(t.env.fields[a].isVectorField){let e=o.mag(),t=o.heading();n+="(a: "+round(1e3*t)/1e3+", m: "+round(1e3*e)/1e3+")"}else n+=round(1e3*o)/1e3}n+=" @ "+(o?"selected storm":"mouse pointer / finger"),viewTick<=t.env.fields[a].accurateAfter&&(n+=" [MAY BE INACCURATE]",i=!0)}else n+="none";this.setBox(void 0,void 0,textWidth(n)+6),this.isHovered()&&(fill(COLORS.UI.buttonHover),e.fullRect()),i?fill("red"):fill(COLORS.UI.text),textAlign(LEFT,TOP),text(n,3,3)},function(){UI.viewBasin.env.displayNext()}),h.append(!1,WIDTH-29,3,24,24,function(e){e.button("?",!1,22)},function(){helpBox.toggleShow()}),stormInfoPanel=primaryWrapper.append(!1,3*WIDTH/4,r.height,WIDTH/4,HEIGHT-r.height-h.height,function(e){let t=this.target;fill(COLORS.UI.box),noStroke(),e.fullRect(),fill(COLORS.UI.text),textAlign(CENTER,TOP),textSize(18);const n=7*this.width/8;if(t instanceof Storm){let e=t.getFullNameByTick("peak"),i=countTextLines(e=wrapText(e,n))*textLeading();text(e,this.width/2,35),textSize(15);let s="";if(s+="Dates active: ",t.inBasinTC){let e=formatDate(UI.viewBasin.tickMoment(t.enterTime)),n=formatDate(UI.viewBasin.tickMoment(t.exitTime));s+=e,t.enterTime>t.formationTime&&(s+=" (entered basin)"),s+=" - ",t.exitTime?(s+=n,(!t.dissipationTime||t.exitTime<t.dissipationTime)&&(s+=" (left basin)")):s+="currently active"}else if(t.TC){let e=formatDate(UI.viewBasin.tickMoment(t.formationTime)),n=formatDate(UI.viewBasin.tickMoment(t.dissipationTime));s+=e+" - "+(t.dissipationTime?n:"currently active")}else s+="N/A";s+="\nPeak pressure: "+(t.peak?t.peak.pressure:"N/A"),s+="\nPeak wind speed: "+(t.windPeak?t.windPeak.windSpeed+" kts":"N/A"),s+="\nACE: "+t.ACE,s+="\nDamage: "+damageDisplayNumber(t.damage),s+="\nDeaths: "+t.deaths,s=wrapText(s+="\nLandfalls: "+t.landfalls,n),text(s,this.width/2,35+i)}else{let e=seasonName(t),i=countTextLines(e=wrapText(e,n))*textLeading();text(e,this.width/2,35),textSize(15);let s,a=UI.viewBasin.fetchSeason(t);if(a instanceof Season){let e=a.stats(DEFAULT_MAIN_SUBBASIN),t=e.classificationCounters,n=UI.viewBasin.getScale(DEFAULT_MAIN_SUBBASIN);s="";for(let{statName:e,cNumber:i}of n.statDisplay())s+=e+": "+t[i]+"\n";s+="Total ACE: "+e.ACE,s+="\nDamage: "+damageDisplayNumber(e.damage),s+="\nDeaths: "+e.deaths,s+="\nLandfalls: "+e.landfalls}else s="Season Data Unavailable";s=wrapText(s,n),text(s,this.width/2,35+i)}},!0,!1),stormInfoPanel.append(!1,3,3,24,24,function(e){let t=stormInfoPanel.target;e.button("",!1,18,t instanceof Storm||t<=UI.viewBasin.getSeason(0)),triangle(19,5,19,19,5,12)},function(){let e=stormInfoPanel.target;!(e instanceof Storm)&&e>UI.viewBasin.getSeason(0)&&stormInfoPanel.target--}),stormInfoPanel.append(!1,stormInfoPanel.width-27,3,24,24,function(e){let t=stormInfoPanel.target;e.button("",!1,18,t instanceof Storm||t>=UI.viewBasin.getSeason(-1)),triangle(5,5,5,19,19,12)},function(){let e=stormInfoPanel.target;!(e instanceof Storm)&&e<UI.viewBasin.getSeason(-1)&&stormInfoPanel.target++}),stormInfoPanel.append(!1,30,3,stormInfoPanel.width-60,24,function(e){e.button("Jump to",!1,15,!paused||void 0===stormInfoPanel.target)},function(){if(paused&&void 0!==stormInfoPanel.target){let e,t=stormInfoPanel.target;t instanceof Storm?(e=t.enterTime?t.enterTime:t.formationTime?t.formationTime:t.birthTime,e=ceil(e/ADVISORY_TICKS)*ADVISORY_TICKS):e=UI.viewBasin.seasonTick(t),changeViewTick(e)}}),stormInfoPanel.append(!1,30,stormInfoPanel.height-27,stormInfoPanel.width-60,24,function(e){e.button("Show Timeline",!1,15)},function(){timelineBox.toggleShow()});timelineBox=primaryWrapper.append(!1,WIDTH/16,HEIGHT/4,7*WIDTH/8,HEIGHT/2,function(e){let t=stormInfoPanel.target;t===this.builtFor&&(UI.viewBasin.tick===this.builtAt||UI.viewBasin.getSeason(this.builtAt)!==t&&UI.viewBasin.getSeason(this.builtAt)!==t+1)||function(){let e=timelineBox;e.parts=[];let t=.9*e.width,n=stormInfoPanel.target;if(void 0===n||n instanceof Storm)e.months=12,e.sMonth=0;else{let i=i=>{let s,a,o=[];for(let e of i.forSystems())if(e.inBasinTC&&(UI.viewBasin.getSeason(e.enterTime)===n||UI.viewBasin.getSeason(e.enterTime)<n&&(void 0===e.exitTime||UI.viewBasin.getSeason(e.exitTime-1)>=n))){o.push(e);let t=e.exitTime||UI.viewBasin.tick;(void 0===s||e.enterTime<s)&&(s=e.enterTime),(void 0===a||t>a)&&(a=t)}for(let e=0;e<o.length-1;e++){let t=o[e],n=o[e+1];t.enterTime>n.enterTime&&(o[e]=n,o[e+1]=t,e>0&&(e-=2))}let l=UI.viewBasin.tickMoment(s);e.sMonth=l.month(),l.startOf("month");let r=UI.viewBasin.tickFromMoment(l),u=UI.viewBasin.tickMoment(a);u.endOf("month");let c=UI.viewBasin.tickFromMoment(u);e.months=u.diff(l,"months")+1;for(let n of o){let i,s,a={};a.storm=n,a.segments=[],a.label=n.getNameByTick(-2);for(let e=0;e<n.record.length;e++){let t=ceil(n.birthTime/ADVISORY_TICKS)*ADVISORY_TICKS+e*ADVISORY_TICKS,s=n.record[e];if(tropOrSub(s.type)&&land.inBasin(s.pos.x,s.pos.y)){let e=UI.viewBasin.getScale(DEFAULT_MAIN_SUBBASIN).get(s);i||(i={},a.segments.push(i),i.startTick=t,i.maxCat=e,i.fullyTrop=s.type===TROP),e>i.maxCat&&(i.maxCat=e),i.fullyTrop=i.fullyTrop||s.type===TROP,i.endTick=t}else i&&(i=void 0)}for(let e=0;e<a.segments.length;e++){let n=a.segments[e];n.startX=map(n.startTick,r,c,0,t),n.endX=map(n.endTick,r,c,0,t)}a.row=-1,textSize(12);let o=textWidth(a.label)+6;do{a.row++,s=!0;for(let t=0;t<e.parts.length;t++){let n=e.parts[t],i=textWidth(n.label)+6,l=a.segments[0].startX,r=a.segments[a.segments.length-1].endX+o,u=n.segments[0].startX,c=n.segments[n.segments.length-1].endX+i;n.row===a.row&&(l>=u&&l<=c||r>=u&&r<=c||u>=l&&u<=r||c>=l&&c<=r)&&(s=!1)}}while(!s);e.parts.push(a)}};UI.viewBasin.fetchSeason(n)?i(UI.viewBasin.fetchSeason(n)):(e.months=12,e.sMonth=0,UI.viewBasin.fetchSeason(n,!1,!1,e=>{i(e)}))}e.builtFor=n,e.builtAt=UI.viewBasin.tick}(),fill(COLORS.UI.box),noStroke(),e.fullRect(),stroke(COLORS.UI.text);let n=this.width,i=this.height,s=.05*n,a=.95*n,o=.2*i,l=.85*i;line(s,l,a,l),line(s,l,s,o),fill(COLORS.UI.text),textAlign(CENTER,TOP),textSize(13);let r,u=["J","F","M","A","M","J","J","A","S","O","N","D"];for(let e=0;e<this.months;e++){stroke(COLORS.UI.text);let t=map(e+1,0,this.months,s,a),n=map(e+.5,0,this.months,s,a);line(t,l,t,o),noStroke(),text(u[(e+this.sMonth)%12],n,l+.02*i)}noStroke(),textSize(18),r=void 0===t?"none":t instanceof Storm?"WIP":seasonName(t),text("Timeline of "+r,.5*n,.05*i);for(let e=0;e<this.parts.length;e++){let t=this.parts[e],n=o+15*t.row,i=getMouseX()-this.getX(),a=getMouseY()-this.getY();textSize(12),i>=s+t.segments[0].startX&&i<s+t.segments[t.segments.length-1].endX+textWidth(t.label)+6&&a>=n&&a<n+10?stroke(255):noStroke();for(let e=0;e<t.segments.length;e++){let i=t.segments[e];fill(UI.viewBasin.getScale(DEFAULT_MAIN_SUBBASIN).getColor(i.maxCat,!i.fullyTrop)),rect(s+i.startX,n,max(i.endX-i.startX,1),10)}let l=s+t.segments[t.segments.length-1].endX;fill(COLORS.UI.text),textAlign(LEFT,CENTER),text(t.label,l+3,n+5)}},function(){let e,t=.05*this.width,n=.2*this.height;for(let i=this.parts.length-1;i>=0;i--){let s=this.parts[i],a=n+15*s.row,o=getMouseX()-this.getX(),l=getMouseY()-this.getY();if(textSize(12),o>=t+s.segments[0].startX&&o<t+s.segments[s.segments.length-1].endX+textWidth(s.label)+6&&l>=a&&l<a+10){e=s.storm;break}}e&&(stormInfoPanel.target=e)},!1),timelineBox.months=12,timelineBox.sMonth=0,timelineBox.parts=[],timelineBox.builtAt=void 0,timelineBox.builtFor=void 0,timelineBox.append(!1,timelineBox.width-30,10,20,20,function(e){e.button("X",!1,22)},function(){timelineBox.hide()});let f=function(e){sideMenu.hide(),stormInfoPanel.hide(),timelineBox.hide(),primaryWrapper.hide(),land.clear(),timelineBox.builtAt=-1;for(let e in UI.viewBasin.seasonExpirationTimers)clearTimeout(UI.viewBasin.seasonExpirationTimers[e]);for(let e in UI.viewBasin.subBasins){let t=UI.viewBasin.subBasins[e];t instanceof SubBasin&&t.mapOutline&&t.mapOutline.remove()}let t=()=>{UI.viewBasin=void 0,mainMenu.show()};e instanceof Promise?e.then(t):t()};sideMenu=primaryWrapper.append(!1,0,r.height,WIDTH/4,HEIGHT-r.height-h.height,function(e){fill(COLORS.UI.box),noStroke(),e.fullRect(),fill(COLORS.UI.text),textAlign(CENTER,TOP),textSize(18),text("Menu",this.width/2,10)},!0,!1),sideMenu.append(!1,5,30,sideMenu.width-10,25,function(e){e.button("Save and Return to Main Menu",!1,15)},function(){UI.viewBasin.saveName===AUTOSAVE_SAVE_NAME?saveBasinAsPanel.invoke(!0):f(UI.viewBasin.save())}).append(!1,0,30,sideMenu.width-10,25,function(e){e.button("Return to Main Menu w/o Saving",!1,15)},function(){areYouSure.dialog(f)}).append(!1,0,30,sideMenu.width-10,25,function(e){let t="Save Basin";UI.viewBasin.tick===UI.viewBasin.lastSaved&&(t+=" [Saved]"),e.button(t,!1,15)},function(){UI.viewBasin.saveName===AUTOSAVE_SAVE_NAME?saveBasinAsPanel.invoke():UI.viewBasin.save()}).append(!1,0,30,sideMenu.width-10,25,function(e){e.button("Save Basin As...",!1,15)},function(){saveBasinAsPanel.invoke()}).append(!1,0,30,sideMenu.width-10,25,function(e){e.button("Settings",!1,15)},function(){primaryWrapper.hide(),settingsMenu.show(),paused=!0}).append(!1,0,30,sideMenu.width-10,25,function(e){e.button("Basin Seed",!1,15)},function(){seedBox.toggleShow(),seedBox.showing&&seedBox.clicked()}),saveBasinAsPanel=sideMenu.append(!1,sideMenu.width,0,3*sideMenu.width/4,100,function(e){fill(COLORS.UI.box),noStroke(),e.fullRect(),fill(COLORS.UI.text),textAlign(CENTER,TOP),textSize(18),text("Save Basin As...",this.width/2,10),stroke(0),line(0,0,0,this.height)},!0,!1);let S=saveBasinAsPanel.append(!1,5,40,saveBasinAsPanel.width-10,25,[15,32,function(){let e=this.value;if(""!==e&&e!==AUTOSAVE_SAVE_NAME)if(e===UI.viewBasin.saveName)UI.viewBasin.save(),saveBasinAsPanel.hide();else{let t=()=>{let t=UI.viewBasin.saveAs(e);saveBasinAsPanel.hide(),saveBasinAsPanel.exit&&f(t)};db.saves.where(":id").equals(e).count().then(n=>{n>0?areYouSure.dialog(t,'Overwrite "'+e+'"?'):t()})}}]);S.append(!1,0,30,saveBasinAsPanel.width-10,25,function(e){let t=UI.focusedInput===S?textInput.value:S.value,n=""===t||t===AUTOSAVE_SAVE_NAME;e.button("Ok",!1,15,n)},function(){S.enterFunc()}),saveBasinAsPanel.invoke=function(e){saveBasinAsPanel.exit=e,saveBasinAsPanel.toggleShow(),S.value=UI.viewBasin.saveName===AUTOSAVE_SAVE_NAME?"":UI.viewBasin.saveName},seedBox=primaryWrapper.append(!1,WIDTH/2-100,HEIGHT/2-15,200,30,[18,void 0,function(){this.value=UI.viewBasin.seed.toString()}],function(){textInput.value=this.value=UI.viewBasin.seed.toString(),textInput.setSelectionRange(0,textInput.value.length)},!1),helpBox=primaryWrapper.append(!1,WIDTH/8,HEIGHT/8,3*WIDTH/4,3*HEIGHT/4,function(e){fill(COLORS.UI.box),noStroke(),e.fullRect(),fill(COLORS.UI.text),textAlign(LEFT,TOP),textSize(15),text(HELP_TEXT,10,10)},!0,!1),helpBox.append(!1,helpBox.width-30,10,20,20,function(e){e.button("X",!1,22)},function(){helpBox.hide()})};
