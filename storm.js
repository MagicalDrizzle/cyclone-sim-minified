class Storm{constructor(t,e){this.basin=t instanceof Basin&&t,this.current=e instanceof ActiveSystem&&e,this.id=void 0,this.current&&t.fetchSeason(-1,!0,!0).addSystem(this),this.TC=!1,this.inBasinTC=!1,this.sbData={},this.rotation=random(TAU),this.designations={},this.designations.primary=[],this.designations.secondary=[],this.birthTime=this.current?t.tick:void 0,this.formationTime=void 0,this.enterTime=void 0,this.exitTime=void 0,this.dissipationTime=void 0,this.deathTime=void 0,this.record=[],this.peak=void 0,this.windPeak=void 0,this.ACE=0,this.deaths=0,this.damage=0,this.landfalls=0,!this.current&&e instanceof LoadData&&this.load(e)}originSeason(){return this.basin.getSeason(this.birthTime)}aliveAt(t){return t>=this.birthTime&&(!!this.current||t<this.deathTime)}getStormDataByTick(t,e){return this.aliveAt(t)?t===this.basin.tick?e?this.current:this.record.length>0?this.record[this.record.length-1]:null:this.record[floor(t/ADVISORY_TICKS)-ceil(this.birthTime/ADVISORY_TICKS)]:null}getNameByTick(t){let e=this.designations,i="";if(this.aliveAt(t)){let s,r,a,o=[];for(let i=0;i<e.primary.length;i++){let r=e.primary[i];if(!(r instanceof Designation))continue;let a=r.activeAt(t);a&&(s?!s.isName()&&r.isName()?s=r:a>s.activeAt(t)&&(!s.isName()||r.isName())&&(s=r):s=r)}for(let i=0;i<e.secondary.length;i++){let s=e.secondary[i];s instanceof Designation&&(s.activeAt(t)&&(s.isName()&&!r&&(o=[],r=!0),!s.isName()&&r||o.push(s)))}o.sort((t,e)=>t.effectiveTicks[0]-e.effectiveTicks[0]);for(let t=o.length-1;t>=0&&(!s||!s.isName());t--)!o[t].isName()&&s||(s=o[t],a=t);if(void 0!==a&&o.splice(a,1),s&&(i+=s.value,o.length>0&&(r||!s.isName()))){i+=" (";for(let t=0;t<o.length;t++)t>0&&(i+=", "),i+=o[t].value;i+=")"}}else{let s,r,a,o=[],n=[];for(let t=0;t<e.primary.length;t++){let i=e.primary[t];i instanceof Designation&&(i.isName()&&!s&&(o=[],s=!0),!i.isName()&&s||o.push(i))}o.sort((t,e)=>t.effectiveTicks[0]-e.effectiveTicks[0]);for(let t=0;t<e.secondary.length;t++){let i=e.secondary[t];i instanceof Designation&&(i.isName()&&!r&&(n=[],r=!0),!i.isName()&&r||n.push(i))}n.sort((t,e)=>t.effectiveTicks[0]-e.effectiveTicks[0]);for(let t=n.length-1;t>=0&&!(o.length>0&&s);t--)(n[t].isName()||o.length<1)&&((o=[]).push(n[t]),n[t].isName()&&(s=!0),a=t);void 0!==a&&n.splice(a,1);for(let e=0;e<o.length;e++)e>0&&(i+="-"),i+=-2===t?o[e].truncate():o[e].value;if(n.length>0&&(r||!s)&&-2!==t){i+=" (";for(let t=0;t<n.length;t++)t>0&&(i+=", "),i+=n[t].value;i+=")"}}return i}getFullNameByTick(t){let e,i=this.basin,s="peak"===t?this.windPeak:this.getStormDataByTick(t),r=this.getNameByTick("peak"===t?-1:t),a=s?s.type:null,o=s?i.getScale(land.getSubBasin(s.pos.x,s.pos.y)).getStormNom(s):null;e="peak"===t?this.TC:t>=this.formationTime;let n="";switch(r||(n+="Unnamed "),a){case TROP:case SUBTROP:n+=o,r&&(n+=" "+r);break;case TROPWAVE:n+=e?r?"Remnants of "+r:"Remnant Low":r?"Invest "+r:"Tropical Wave";break;case EXTROP:e?(n+="Post-Tropical Cyclone",r&&(n+=" "+r)):n+=r?"Invest "+r:"Extratropical Cyclone"}return n}renderIcon(){if(this.aliveAt(viewTick)){let t=this.basin,e=this.getStormDataByTick(viewTick),i=this.getStormDataByTick(viewTick,!0),s=e||i,r=i.pressure,a=i.windSpeed,o=i.pos,n=land.getSubBasin(s.pos.x,s.pos.y),h=t.getScale(n).getIcon(s),l=s.type,d=this.getNameByTick(viewTick);this.rotation-=.03*pow(1.01,ktsToMph(min(270,a)));let m=()=>{let e=h.arms;if(tropOrSub(l)&&e){stormIcons.push(),t.SHem&&stormIcons.scale(1,-1),stormIcons.rotate(this.rotation);for(let t=0;t<e;t++)t>0&&stormIcons.rotate(2*PI/e),stormIcons.beginShape(),stormIcons.vertex(5*DIAMETER/8,-DIAMETER),stormIcons.bezierVertex(5*DIAMETER/8,-DIAMETER,3*-DIAMETER/8,7*-DIAMETER/8,1*-DIAMETER/2,0),stormIcons.vertex(0,0),stormIcons.bezierVertex(1*-DIAMETER/4,5*-DIAMETER/8,5*DIAMETER/8,-DIAMETER,5*DIAMETER/8,-DIAMETER),stormIcons.endShape();stormIcons.pop()}};stormIcons.push(),stormIcons.translate(o.x,o.y),stormIcons.textAlign(CENTER,CENTER),selectedStorm===this&&(stormIcons.noFill(),stormIcons.stroke(255),l===EXTROP?(stormIcons.textSize(18),stormIcons.text("L",0,0)):stormIcons.ellipse(0,0,DIAMETER),m()),stormIcons.fill(h.color),stormIcons.noStroke(),l!==EXTROP&&stormIcons.ellipse(0,0,DIAMETER),m(),l===EXTROP?(stormIcons.fill(COLORS.storm.extL),stormIcons.textSize(18)):(stormIcons.fill(brightness(h.color)<75?240:0),stormIcons.textSize(12)),stormIcons.textStyle(NORMAL),stormIcons.text(tropOrSub(l)?h.symbol:"L",0,0),stormIcons.fill(0),simSettings.showStrength&&(stormIcons.textSize(10),stormIcons.text(floor(a)+" / "+floor(r),0,DIAMETER)),d&&(stormIcons.textAlign(LEFT,CENTER),stormIcons.textSize(14),stormIcons.text(d,DIAMETER,0)),stormIcons.pop()}}renderTrack(t){if(3!==simSettings.trackMode){if(this.inBasinTC||1===simSettings.trackMode)if(t){if(this.record.length>1&&(selectedStorm===this||void 0===selectedStorm)){let t=(this.record.length-2)*ADVISORY_TICKS+ceil(this.birthTime/ADVISORY_TICKS)*ADVISORY_TICKS,e=this.record[this.record.length-2],i=this.basin.getScale(land.getSubBasin(e.pos.x,e.pos.y)).getColor(e);tracks.stroke(i);let s=e.pos,r=this.record[this.record.length-1].pos;(1===simSettings.trackMode||t>=this.formationTime&&(!this.dissipationTime||t<this.dissipationTime))&&tracks.line(s.x,s.y,r.x,r.y)}}else if(this.aliveAt(viewTick)||2===simSettings.trackMode||selectedStorm===this)for(let t=0;t<this.record.length-1;t++){let e=t*ADVISORY_TICKS+ceil(this.birthTime/ADVISORY_TICKS)*ADVISORY_TICKS;if(1!==simSettings.trackMode){if(e<this.formationTime)continue;if(e>=this.dissipationTime)break}let i=this.record[t],s=this.basin.getScale(land.getSubBasin(i.pos.x,i.pos.y)).getColor(i);tracks.stroke(s);let r=i.pos,a=this.record[t+1].pos;tracks.line(r.x,r.y,a.x,a.y)}if(selectedStorm===this&&this.basin.viewingPresent()&&this.current){forecastTracks.clear();let t=this.current.trackForecast.points;for(let e=0;e<t.length;e++)forecastTracks.point(t[e].x,t[e].y)}}}updateStats(t){let e=this.basin,i=t.windSpeed,s=t.pressure,r=t.type,a=e.getSeason(-1),o=e.fetchSeason(a,!1,!0),n=this.record.length>0?this.record[this.record.length-1]:void 0,h=land.getSubBasin(t.pos.x,t.pos.y),l=n?land.getSubBasin(n.pos.x,n.pos.y):h,d=!!n&&tropOrSub(n.type),m=tropOrSub(r),p=m&&e.subInBasin(h),c=d&&e.subInBasin(l);!this.TC&&m&&(this.TC=!0,this.formationTime=e.tick,this.peak=void 0,this.windPeak=void 0),!this.inBasinTC&&p&&(this.inBasinTC=!0,this.enterTime=e.tick,this.peak=void 0,this.windPeak=void 0,this.ACE=0,this.damage=0,this.deaths=0,this.landfalls=0,d&&refreshTracks(!0));let f=0;i>=ACE_WIND_THRESHOLD&&(p||m&&!this.inBasinTC)&&(f=pow(i,2)/ACE_DIVISOR,this.ACE+=f,this.ACE=round(this.ACE*ACE_DIVISOR)/ACE_DIVISOR);for(let i of e.forSubBasinChain(h)){let s=e.subBasins[i],r=e.getScale(i).get(t);if(e.subInBasin(i)){let t=o.stats(i),e=t.classificationCounters;if(m)for(let t=0;t<=r;t++)this.subBasinData(i,a,t,!0)||e[t]++;t.addACE(f)}if(s instanceof SubBasin&&s.designationSystem){let t=s.designationSystem,o=this.designations.secondary,n=e.getScale(i).numberingThreshold;void 0!==t.numbering.threshold&&(n=t.numbering.threshold);let h=e.getScale(i).namingThreshold;if(void 0!==t.naming.threshold&&(h=t.naming.threshold),t.secondary){if(t.numbering.enabled&&m&&r>=n&&!this.subBasinData(i,a,"num",!0)){let e=t.getNewNum();e&&o.push(e)}if(t.naming.mainLists.length>0&&m&&r>=h&&!this.subBasinData(i,a,"name",!0)){let e=t.getNewName();e&&o.push(e)}}}}let S,u,g=e.relevantPrimaryDesignationSubBasins(h),T=e.subBasins[g.numbering],I=e.subBasins[g.naming];T instanceof SubBasin&&(S=T.designationSystem),I instanceof SubBasin&&(u=I.designationSystem);let D,b,y,v,E,A,C=this.designations.primary;for(let i=0;i<=1;i++){if(i){if(b=g.naming,E=e.getScale(b).namingThreshold,!u){m&&!this.subBasinData(h,a,"name",!0)&&(D=!0);continue}y=u.naming,A="name"}else{if(b=g.numbering,E=e.getScale(b).numberingThreshold,!S){m&&!this.subBasinData(h,a,"num",!0)&&(D=!0);continue}y=S.numbering,A="num"}v=e.getScale(b).get(t),void 0!==y.threshold&&(E=y.threshold);let s=g.altPre,r=g.altSuf;if(m&&v>=E&&!this.subBasinData(b,a,A,!0)){let a=!1,o=!1;switch(y.crossingMode){case DESIG_CROSSMODE_ALWAYS:a=!0;break;case DESIG_CROSSMODE_REGEN:case DESIG_CROSSMODE_STRICT_REGEN:let s=t;for(let t=this.record.length-1;t>=0&&tropOrSub(this.record[t].type);t--)s=this.record[t];let r=land.getSubBasin(s.pos.x,s.pos.y);r=e.relevantPrimaryDesignationSubBasins(r),(r=i?r.naming:r.numbering)!==b?o=!0:y.crossingMode===DESIG_CROSSMODE_REGEN&&(a=!0);break;case DESIG_CROSSMODE_KEEP:o=!0}let n=!1;if(a)for(let t=0;t<C.length;t++){let s=C[t];if(s.subBasin===b&&(i?s.isName():!s.isName())){s.show(e.tick),n=!0,D=!0;break}}else if(o)for(let t=0;t<C.length;t++){let s=C[t];if(s.activeAt(e.tick)&&(i?s.isName():!s.isName())){n=!0,D=!0;break}}if(!n){let t;(t=i?u.getNewName():S.getNewNum(s,r))&&(C.push(t),D=!0)}}}if(D)for(let t=0;t<C.length;t++){let i=C[t],s=i.subBasin;s!==(b=i.isName()?g.naming:g.numbering)&&i.activeAt(e.tick)&&(A=i.isName()?"name":"num",this.subBasinData(s,a,A,!1))}d&&!m&&(this.dissipationTime=e.tick),!d&&m&&(this.dissipationTime=void 0,this.formationTime!==e.tick&&refreshTracks(!0)),c&&!p&&(this.exitTime=e.tick),!c&&p&&(this.exitTime=void 0),(this.inBasinTC||this.TC&&!m)&&!p||(this.peak?s<this.peak.pressure&&(this.peak=t):this.peak=t,this.windPeak?i>this.windPeak.windSpeed&&(this.windPeak=t):this.windPeak=t),o.modified=!0,e.fetchSeason(this.originSeason(),!1,!0).modified=!0}subBasinData(t,e,i,s){this.sbData[t]||(this.sbData[t]={});let r=this.sbData[t];if("number"==typeof i){r.classLog||(r.classLog={}),(r=r.classLog)[e]||(r[e]={});let t=(r=r[e])[i];return void 0!==s&&(r[i]=s),t}if("num"===i){let t=r.numFlag;return void 0!==s&&(r.numFlag=s),t}if("name"===i){let t=r.nameFlag;return void 0!==s&&(r.nameFlag=s),t}}save(){let t={};for(let e of["id","birthTime","deaths","damage","landfalls"])t[e]=this[e];t.record=StormData.saveArr(this.record),t.designations={},t.designations.primary=[],t.designations.secondary=[];let e=this.designations.primary,i=this.designations.secondary;for(let i=0;i<e.length;i++)t.designations.primary.push(e[i].save());for(let e=0;e<i.length;e++)t.designations.secondary.push(i[e].save());return this.current&&(t.sbData=this.sbData),t}load(t){if(t instanceof LoadData){let e,i,s,r,a=this.basin;if(t.format>=FORMAT_WITH_INDEXEDDB){let i=t.value;this.record=StormData.loadArr(a,t.sub(i.record));for(let t of["id","birthTime","deaths","damage","landfalls"])this[t]=i[t];if(this.birthTime||(this.birthTime=0),this.deaths||(this.deaths=0),this.damage||(this.damage=0),this.landfalls||(this.landfalls=0),void 0!==i.depressionNum&&(s=i.depressionNum),void 0!==i.nameNum&&(e=i.nameNum),void 0!==i.designations&&(r=i.designations),i.sbData&&(this.sbData=i.sbData,t.format<FORMAT_WITH_SCALES))for(let t in this.sbData){let e=this.sbData[t].classLog;if(e)for(let t in e){let i=e[t],s={};for(let t in i){let e=+t;void 0!==i[t]&&(s[Scale.convertOldValue(e)]=i[t],"5"===t&&(s[6]=i[t]))}e[t]=s}}}else{let i=t.value;i=i.split(".");let r=decodeB36StringArray(i[0]);this.record=StormData.loadArr(a,t.sub(i[1])),this.damage=r.pop()*DAMAGE_DIVISOR||0,this.deaths=r.pop()||0,this.birthTime=r.pop()||0,(e=r.pop())<0&&(e=void 0),(s=r.pop())<0&&(s=void 0),this.id=r.pop()||0}for(let e=0;e<this.record.length;e++){let s=this.record[e],r=land.getSubBasin(s.pos.x,s.pos.y),o=tropOrSub(s.type),n=o&&a.subInBasin(r),h=(e+ceil(this.birthTime/ADVISORY_TICKS))*ADVISORY_TICKS,l=a.getSeason(h);o&&!this.formationTime&&(this.formationTime=h),o&&this.dissipationTime&&(this.dissipationTime=void 0),o||!this.formationTime||this.dissipationTime||(this.dissipationTime=h),n&&!this.enterTime&&(this.enterTime=h),n&&this.exitTime&&(this.exitTime=void 0),n||!this.enterTime||this.exitTime||(this.exitTime=h);let d=Scale.extendedSaffirSimpson.get(s);if(n&&!i&&d>=1&&(i=h),t.format<FORMAT_WITH_STORM_SUBBASIN_DATA&&n){for(let t of a.forSubBasinChain(r))for(let e=0;e<=d;e++)this.subBasinData(t,l,e,!0);this.subBasinData(DEFAULT_MAIN_SUBBASIN,l,"num",!0),d>=1&&this.subBasinData(DEFAULT_MAIN_SUBBASIN,l,"name",!0)}o&&!this.TC&&(this.TC=!0,this.peak=void 0,this.windPeak=void 0),n&&!this.inBasinTC&&(this.inBasinTC=!0,this.peak=void 0,this.windPeak=void 0,this.ACE=0),(this.inBasinTC||this.TC&&!o)&&!n||(this.peak?s.pressure<this.peak.pressure&&(this.peak=s):this.peak=s,this.windPeak?s.windSpeed>this.windPeak.windSpeed&&(this.windPeak=s):this.windPeak=s),s.windSpeed>=ACE_WIND_THRESHOLD&&(n||o&&!this.inBasinTC)&&(this.ACE*=ACE_DIVISOR,this.ACE+=pow(s.windSpeed,2),this.ACE/=ACE_DIVISOR)}this.ACE=round(this.ACE*ACE_DIVISOR)/ACE_DIVISOR;for(let e of a.activeSystems)e.storm instanceof StormRef&&e.storm.season===t.season&&e.storm.refId===this.id&&(this.current=e,e.storm=this);if(this.current||(this.deathTime=(this.record.length-1+ceil(this.birthTime/ADVISORY_TICKS))*ADVISORY_TICKS+1),this.TC&&!this.dissipationTime&&(this.dissipationTime=this.deathTime),this.inBasinTC&&!this.exitTime&&(this.exitTime=this.dissipationTime),r){let e=r.primary,i=r.secondary;for(let i=0;i<e.length;i++)this.designations.primary.push(new Designation(t.sub(e[i])));for(let e=0;e<i.length;e++)this.designations.secondary.push(new Designation(t.sub(i[e])))}else{let t=a.subBasins[DEFAULT_MAIN_SUBBASIN];if(t instanceof SubBasin&&t.designationSystem){if(void 0!==e){let s=t.designationSystem.getName(i,a.getSeason(i),e);s&&this.designations.primary.push(s)}if(void 0!==s){let e=t.designationSystem.getNum(this.enterTime,s);e&&this.designations.primary.push(e)}}}}}}class StormRef{constructor(t,e){t instanceof Basin&&(this.basin=t),e instanceof Storm?(this.season=e.originSeason(),this.refId=e.id,this.lastApplicableAt=e.deathTime,this.ref=void 0):e instanceof LoadData&&(this.season=void 0,this.refId=void 0,this.ref=void 0,this.lastApplicableAt=void 0,this.load(e))}fetch(){let t=this.basin;if(this.ref&&t.seasons[this.season])return this.ref;let e=t.fetchSeason(this.season);return e?(this.ref=e.fetchSystemById(this.refId),this.ref):(t.fetchSeason(this.season,!1,!1,t=>{this.ref=t.fetchSystemById(this.refId)}),null)}save(){let t={};for(let e of["refId","season","lastApplicableAt"])t[e]=this[e];return t}load(t){if(t instanceof LoadData)if(t.format>=FORMAT_WITH_INDEXEDDB)for(let e of["refId","season","lastApplicableAt"])this[e]=t.value[e];else{let e=t.value,i=decodeB36StringArray(e);this.season=i.pop(),this.refId=i.pop()}}}class StormData{constructor(t,e,i,s,r,a){t instanceof Basin&&(this.basin=t),this.pos=void 0,this.pressure=void 0,this.windSpeed=void 0,this.type=void 0,e instanceof LoadData?this.load(e,i):(this.pos=createVector(e,i),this.pressure=s,this.windSpeed=r,this.type=a<STORM_TYPES?a:EXTROP)}save(){let t={};t.pos={x:this.pos.x,y:this.pos.y};for(let e of["pressure","windSpeed","type"])t[e]=this[e];return t}load(t,e){if(t instanceof LoadData)if(t.format>=FORMAT_WITH_INDEXEDDB){let e=t.value;this.pos=createVector(e.pos.x,e.pos.y);for(let t of["pressure","windSpeed","type"])this[t]=e[t]}else{let i=t.value,s=decodeB36StringArray(i);if(this.type=s.pop(),this.windSpeed=s.pop(),this.pressure=s.pop(),e)this.pos=e;else{let t={p5Vec:!0};this.pos=decodePoint(s.pop(),t)}}}static saveArr(t){let e=[],i=[],s=[],r=[],a=[];for(let o of t)o instanceof StormData&&(e.push(o.pos.x),i.push(o.pos.y),s.push(constrain(o.pressure,0,pow(2,16)-1)),r.push(constrain(o.windSpeed,0,pow(2,16)-1)),a.push(o.type));let o={};return o.pos={x:new Float32Array(e),y:new Float32Array(i)},o.pressure=new Uint16Array(s),o.windSpeed=new Uint16Array(r),o.type=new Uint8ClampedArray(a),o}static loadArr(t,e){if(t instanceof Basin&&e instanceof LoadData){if(e.format>=FORMAT_WITH_INDEXEDDB){let i=e.value,s=[],r=[...i.pos.x],a=[...i.pos.y],o=[...i.pressure],n=[...i.windSpeed],h=[...i.type];for(let e=0;e<r.length;e++)s[e]=new StormData(t,r[e],a[e],o[e],n[e],h[e]);return s}{let i=e.value.split("/"),s={p5Vec:!0},r=decodePointArray(i.shift(),s);for(let s=0;s<i.length;s++)i[s]=new StormData(t,e.sub(i[s]),r[s]);return i}}}}class ActiveSystem extends StormData{constructor(t,e,i){if(t instanceof Basin){if(e instanceof LoadData)super(t),this.organization=void 0,this.lowerWarmCore=void 0,this.upperWarmCore=void 0,this.depth=void 0;else{let s=i?i.sType:void 0;"x"===s&&(e=!0);let r,a,o,n=!1;if("sd"===s&&(s="d",n=!0),"ss"===s&&(s="s",n=!0),i)r=i.x,a=i.y;else do{o=!1,r=random()<.2&&!e?WIDTH-1:random(0,WIDTH-1),a=t.hemY(e?t.env.get("jetstream",r,0,t.tick)+random(-75,75):random(.7*HEIGHT,.9*HEIGHT));for(let e=0;e<t.activeSystems.length;e++){let i=t.activeSystems[e].pos;sqrt(sq(r-i.x)+sq(a-i.y))<50&&(o=!0)}}while(o);super(t,r,a,i?"x"===s?1005:"l"===s?1015:"d"===s?1005:"s"===s?995:"1"===s?985:"2"===s?975:"3"===s?960:"4"===s?945:"5"===s?925:"6"===s?890:"7"===s?840:"8"===s?800:"9"===s?765:"10"===s?730:"y"===s?690:1e3:random(1e3,1020),i?"x"===s?15:"l"===s?15:"d"===s?25:"s"===s?45:"1"===s?70:"2"===s?90:"3"===s?105:"4"===s?125:"5"===s?145:"6"===s?170:"7"===s?210:"8"===s?270:"9"===s?330:"10"===s?400:"y"===s?440:35:random(15,35),e?EXTROP:i?"l"===s?TROPWAVE:n?SUBTROP:TROP:TROPWAVE),this.organization=e?0:i?"l"===s?.2:1:random(0,.3),this.lowerWarmCore=e?0:n?.6:1,this.upperWarmCore=e?0:n?.5:1,this.depth=e?1:0}this.steering=createVector(0),this.interaction={},this.interaction.fuji=createVector(0),this.interaction.fujiStatic=createVector(0),this.interaction.shear=0,this.interaction.kill=!1,this.trackForecast={},this.trackForecast.stVec=createVector(0),this.trackForecast.pVec=createVector(0),this.trackForecast.points=[],e instanceof LoadData?(this.storm=void 0,this.load(e)):(this.storm=new Storm(t,this),t.tick%ADVISORY_TICKS==0&&this.advisory())}}update(){let t=this.basin,e=land.get(this.pos.x,this.pos.y);this.getSteering(),this.pos.add(this.steering);let i=this.pos.x,s=this.pos.y,r=t.tick,a=t.env.get("SST",i,s,r),o=t.env.get("jetstream",i,s,r);o=t.hemY(s)-o;let n=land.get(i,s),h=t.env.get("moisture",i,s,r),l=t.env.get("shear",i,s,r).mag()+this.interaction.shear,d=(n?this.lowerWarmCore:max(pow(map(a,10,25,0,1,!0),3),this.lowerWarmCore))*map(o,0,75,sq(1-this.depth),1,!0);this.lowerWarmCore=lerp(this.lowerWarmCore,d,this.lowerWarmCore>d?map(o,0,75,.4,.06,!0):.04),this.upperWarmCore=lerp(this.upperWarmCore,this.lowerWarmCore,this.lowerWarmCore>this.upperWarmCore?.05:.4),this.lowerWarmCore=constrain(this.lowerWarmCore,0,1),this.upperWarmCore=constrain(this.upperWarmCore,0,1);let m=constrain(map(this.lowerWarmCore,.5,1,0,1),0,this.upperWarmCore),p=constrain(map(this.lowerWarmCore,.75,0,0,1),0,1);this.organization*=100,n||(this.organization+=3*sq(map(a,20,29,0,1,!0))*m),!n&&this.organization<40&&(this.organization+=lerp(0,3,p)),this.organization-=pow(2,4-(HEIGHT-t.hemY(s))/(.01*HEIGHT)),this.organization-=(pow(map(this.depth,0,1,1.17,1.31),l)-1)*map(this.depth,0,1,4.7,1.2),this.organization-=map(h,0,.65,3,0,!0)*l,this.organization+=4*sq(map(h,.6,1,0,1,!0)),this.organization-=pow(1.3,20-a)*m,this.organization=constrain(this.organization,0,100),this.organization/=100;let c=1010-25*log(n||a<25?1:map(a,25,30,1,2))/log(1.17);c=lerp(1010,c,pow(this.organization,3)),this.pressure=lerp(this.pressure,c,(this.pressure>c?.05:.08)*m),this.pressure-=random(-3,3.5)*p,this.organization<.3&&(this.pressure+=random(-2,2.5)*m),this.pressure+=random(constrain(970-this.pressure,0,40))*p,this.pressure+=.5*this.interaction.shear/(1+map(this.lowerWarmCore,0,1,4,0)),this.pressure+=map(o,0,75,5*pow(1-this.depth,4),0,!0);let f=map(this.pressure,1030,900,1,160)*map(this.lowerWarmCore,1,0,1,.6);this.windSpeed=lerp(this.windSpeed,f,.15);let S=map(this.upperWarmCore,0,1,1,map(this.organization,0,1,this.depth*pow(.95,l),max(map(this.pressure,1010,950,0,.7,!0),this.depth)));switch(this.depth=lerp(this.depth,S,.05),this.type){case TROP:this.type=this.lowerWarmCore<.55?EXTROP:this.organization<.4&&this.windSpeed<50||this.windSpeed<20?this.upperWarmCore<.56?EXTROP:TROPWAVE:this.upperWarmCore<.56?SUBTROP:TROP;break;case SUBTROP:this.type=this.lowerWarmCore<.55?EXTROP:this.organization<.4&&this.windSpeed<50||this.windSpeed<20?this.upperWarmCore<.57?EXTROP:TROPWAVE:this.upperWarmCore<.57?SUBTROP:TROP;break;case TROPWAVE:this.type=this.lowerWarmCore<.55?EXTROP:this.organization<.45||this.windSpeed<25?this.upperWarmCore<.56?EXTROP:TROPWAVE:this.upperWarmCore<.56?SUBTROP:TROP;break;default:this.type=this.lowerWarmCore<.6?EXTROP:this.organization<.45||this.windSpeed<25?this.upperWarmCore<.57?EXTROP:TROPWAVE:this.upperWarmCore<.57?SUBTROP:TROP}if(this.pressure>1030||this.pos.x>=WIDTH||this.pos.x<0||this.pos.y>=HEIGHT||this.pos.y<0||this.interaction.kill)return this.fetchStorm().deathTime=t.tick,this.fetchStorm().TC&&void 0===this.fetchStorm().dissipationTime&&(this.fetchStorm().dissipationTime=t.tick),this.fetchStorm().inBasinTC&&void 0===this.fetchStorm().exitTime&&(this.fetchStorm().exitTime=t.tick),void(this.fetchStorm().current=void 0);let u=this.fetchStorm().getStormDataByTick(t.tick);if(tropOrSub(null!==(u=u&&u.type)?u:this.type)){let r=n?round(25e4*(1+t.hemY(s)/HEIGHT)*pow(.8,map(n,.5,1,0,30))):0,a=pow(1.062,this.windSpeed)-1,o=pow(1.045,this.windSpeed)-1,h=pow(1.5,randomGaussian());o*=h;let l=r*(a*=h)*3.3*pow(1.1,random(-1,1)),d=round(r*o*17e-7*pow(1.1,random(-1,1))),m=0;!e&&n&&(m=1);let p=land.getSubBasin(i,s);this.fetchStorm().inBasinTC&&!t.subInBasin(p)||(this.fetchStorm().damage+=l,this.fetchStorm().damage=round(100*this.fetchStorm().damage)/100,this.fetchStorm().deaths+=d,this.fetchStorm().landfalls+=m);let c=t.fetchSeason(-1,!0,!0);for(let e of t.forSubBasinChain(p))if(t.subInBasin(e)){let t=c.stats(e);t.damage+=l,t.damage=round(100*t.damage)/100,t.deaths+=d,t.landfalls+=m}c.modified=!0}this.resetInteraction(),t.tick%ADVISORY_TICKS==0&&this.advisory()}advisory(){let t=floor(this.pos.x),e=floor(this.pos.y),i=floor(this.pressure),s=round(this.windSpeed/WINDSPEED_ROUNDING)*WINDSPEED_ROUNDING,r=this.type,a=new StormData(this.basin,t,e,i,s,r);this.fetchStorm().updateStats(a),this.fetchStorm().record.push(a),this.doTrackForecast(),this.fetchStorm().renderTrack(!0)}getSteering(){let t=this.basin,e=t.env.get("LLSteering",this.pos.x,this.pos.y,t.tick),i=t.env.get("ULSteering",this.pos.x,this.pos.y,t.tick),s=sqrt(this.depth),r=lerp(e.x,i.x,s),a=lerp(e.y,i.y,s);this.steering.set(r,a),this.steering.add(this.interaction.fuji)}interact(t,e){let i=this.basin,s=this.interaction.fujiStatic;s.set(this.pos),s.sub(t.pos);let r=s.mag(),a=map(t.lowerWarmCore,0,1,150,50);r<a&&r>0&&(s.rotate(i.hem(-TAU/4+3/r*TAU/16)),s.setMag(map(r,a,0,0,map(constrain(t.pressure,990,1030),1030,990,.2,2.2))),this.interaction.fuji.add(s),this.interaction.shear+=map(r,a,0,0,map(t.pressure,1030,900,0,6)),(r<map(this.pressure,1030,1e3,a/5,a/15)||r<5)&&this.pressure>t.pressure&&(this.interaction.kill=!0)),e&&t.interact(this)}resetInteraction(){let t=this.interaction;t.fuji.set(0),t.shear=0}doTrackForecast(){let t=this.basin,e=this.trackForecast.pVec,i=this.trackForecast.stVec;this.trackForecast.points=[],e.set(this.pos);for(let s=0;s<120;s++){let r=t.tick+s,a=t.env.get("LLSteering",e.x,e.y,r),o=t.env.get("ULSteering",e.x,e.y,r),n=sqrt(this.depth),h=lerp(a.x,o.x,n),l=lerp(a.y,o.y,n);i.set(h,l),e.add(i),(s+1)%ADVISORY_TICKS==0&&this.trackForecast.points.push({x:e.x,y:e.y})}}fetchStorm(){if(this.storm instanceof StormRef){console.error("ActiveSystem still needs to fetch StormRefs");let t=this.storm.fetch();if(!t)return new Storm(this.basin);this.storm=t,this.storm.deathTime=void 0;let e=this.storm.record;e.length>0&&tropOrSub(e[e.length-1].type)&&(this.storm.dissipationTime=void 0,land.inBasin(e[e.length-1].pos.x,e[e.length-1].pos.y)&&(this.storm.exitTime=void 0)),this.storm.current=this}return this.storm}save(){let t=super.save();for(let e of["organization","lowerWarmCore","upperWarmCore","depth"])t[e]=this[e];return t.ref=new StormRef(this.basin,this.fetchStorm()).save(),t}load(t){if(t instanceof LoadData)if(t.format>=FORMAT_WITH_INDEXEDDB){let e=t.value;super.load(t);for(let t of["organization","lowerWarmCore","upperWarmCore","depth"])this[t]=e[t];this.storm=new StormRef(this.basin,t.sub(e.ref))}else{let e=t.value.split(".");super.load(t.sub(e[0]));let i=decodeB36StringArray(e[1]);this.depth=i.pop(),this.upperWarmCore=i.pop(),this.lowerWarmCore=i.pop(),this.organization=i.pop(),this.storm=new StormRef(this.basin,t.sub(e[2]))}}}function tropOrSub(t){return t===TROP||t===SUBTROP}