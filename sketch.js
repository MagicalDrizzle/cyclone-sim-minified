var paused,land,newBasinSettings,waitingFor,waitingDescs,waitingTCSymbolSHem,simSettings,textInput,buffers,scaler,tracks,stormIcons,forecastTracks,landBuffer,outBasinBuffer,landShader,coastLine,envLayer,magnifyingGlass,snow,simSpeed,simSpeedFrameCounter,keyRepeatFrameCounter,viewTick,selectedStorm,renderToDo,oldMouseX,oldMouseY;function setup(){setVersion(TITLE+" v",VERSION_NUMBER),document.title=TITLE,versionLink.onmouseover=(()=>setVersion(TITLE+" v",VERSION_NUMBER+" (b"+BUILD_NUMBER+")")),versionLink.onmouseleave=(()=>setVersion(TITLE+" v",VERSION_NUMBER)),setupDatabase(),createCanvas(WIDTH,HEIGHT),defineColors(),background(COLORS.bg),paused=!1,newBasinSettings={},waitingFor=0,(waitingDescs={}).lowestAvailable=0,waitingDescs.maxIndex=-1,waitingTCSymbolSHem=!1,simSettings=new Settings,(textInput=document.createElement("input")).type="text",document.body.appendChild(textInput),textInput.style.position="absolute",textInput.style.left="-500px",textInput.onblur=(()=>{UI.focusedInput&&(UI.focusedInput.value=textInput.value),UI.focusedInput=void 0}),buffers=new Map,scaler=1;let{fullW:e,fullH:t}=fullDimensions();(tracks=createBuffer()).strokeWeight(2),(stormIcons=createBuffer()).strokeWeight(3),(forecastTracks=createBuffer()).strokeWeight(3),forecastTracks.stroke(240,240,0),(landBuffer=createBuffer(e,t,!0)).noStroke(),(outBasinBuffer=createBuffer(e,t,!0)).noStroke(),outBasinBuffer.fill(COLORS.outBasin),(landShader=createBuffer(e,t,!0)).noStroke(),(coastLine=createBuffer(e,t,!0)).fill(0),coastLine.noStroke(),(envLayer=createBuffer(WIDTH,HEIGHT,!1,!0)).colorMode(HSB),envLayer.strokeWeight(2),envLayer.noStroke(),(magnifyingGlass=createBuffer(4*ENV_LAYER_TILE_SIZE,4*ENV_LAYER_TILE_SIZE,!1,!0)).colorMode(HSB),magnifyingGlass.strokeWeight(2),magnifyingGlass.noStroke(),snow=[];for(let s=0;s<MAX_SNOW_LAYERS;s++)snow[s]=createBuffer(e,t,!0),snow[s].noStroke(),snow[s].fill(COLORS.snow);simSpeed=0,simSpeedFrameCounter=0,keyRepeatFrameCounter=0,upgradeLegacySaves(),UI.init()}function draw(){try{if(scale(scaler),background(COLORS.bg),waitingFor<1){if(UI.viewBasin instanceof Basin){if(renderToDo){let e=renderToDo.next();return e.done?void(renderToDo=void 0):(push(),textSize(48),textAlign(CENTER,CENTER),text(e.value,WIDTH/2,HEIGHT/2),void pop())}if(stormIcons.clear(),paused||(simSpeedFrameCounter++,0===(simSpeedFrameCounter%=pow(2,simSpeed))&&UI.viewBasin.advanceSim()),keyRepeatFrameCounter++,keyIsPressed&&document.activeElement!==textInput&&(keyRepeatFrameCounter>=KEY_REPEAT_COOLDOWN||0===keyRepeatFrameCounter)&&keyRepeatFrameCounter%KEY_REPEATER==0&&paused&&primaryWrapper.showing)if(keyCode===LEFT_ARROW&&viewTick>=ADVISORY_TICKS)changeViewTick(ceil(viewTick/ADVISORY_TICKS-1)*ADVISORY_TICKS);else if(keyCode===RIGHT_ARROW){let e;e=viewTick<UI.viewBasin.tick-ADVISORY_TICKS?floor(viewTick/ADVISORY_TICKS+1)*ADVISORY_TICKS:UI.viewBasin.tick,changeViewTick(e)}mouseX===oldMouseX&&mouseY===oldMouseY||!simSettings.showMagGlass||UI.viewBasin.env.updateMagGlass()}UI.updateMouseOver(),UI.renderAll()}else{let e=100;push(),translate(WIDTH/2,HEIGHT/2),push(),noStroke(),fill(COLORS.UI.loadingSymbol),ellipse(0,0,e),waitingTCSymbolSHem&&scale(1,-1),rotate(millis()*-PI/500),beginShape(),vertex(5*e/8,-e),bezierVertex(5*e/8,-e,3*-e/8,7*-e/8,1*-e/2,0),vertex(0,0),bezierVertex(1*-e/4,5*-e/8,5*e/8,-e,5*e/8,-e),endShape(),rotate(PI),beginShape(),vertex(5*e/8,-e),bezierVertex(5*e/8,-e,3*-e/8,7*-e/8,1*-e/2,0),vertex(0,0),bezierVertex(1*-e/4,5*-e/8,5*e/8,-e,5*e/8,-e),endShape(),pop(),textSize(48),textAlign(CENTER,CENTER);let t="";for(let e=0;e<=waitingDescs.maxIndex;e++)waitingDescs[e]&&(""!==t&&(t+="\n"),t+=waitingDescs[e]);text(t,0,0),pop()}oldMouseX=mouseX,oldMouseY=mouseY}catch(e){resetMatrix(),colorMode(RGB),background(15,15,200),fill(255),textSize(24),textAlign(LEFT,TOP),text("An irregularity has been detected, please refer to the error log for more information.",width/16,height/8),textSize(15),text(e.stack,width/16,height/4),console.error(e),noLoop()}}class Settings{constructor(){const e=Settings.order(),t=Settings.defaults();waitForAsyncProcess(()=>db.settings.get(DB_KEY_SETTINGS),"Retrieving Settings...").catch(e=>{console.error(e)}).then(s=>{let o=s;if(!o){let e=LOCALSTORAGE_KEY_PREFIX+LOCALSTORAGE_KEY_SETTINGS;(o=localStorage.getItem(e))?(o=decodeB36StringArray(o),db.settings.put(o,DB_KEY_SETTINGS).then(()=>{localStorage.removeItem(e)}).catch(e=>{console.error(e)})):o=[]}for(let s=e.length-1;s>=0;s--)o.length>0?this[e[s]]=o.pop():this[e[s]]=t[s];let r=e=>(t,s)=>{this.set(e,t,s)};for(let t=0;t<e.length;t++){this["set"+e[t].charAt(0).toUpperCase()+e[t].slice(1)]=r(e[t])}})}static order(){return["smoothLandColor","showMagGlass","snowLayers","useShader","trackMode","showStrength","doAutosave"]}static defaults(){return[!0,!1,2,!1,0,!1,!0]}save(){const e=Settings.order();let t=[];for(let s=0;s<e.length;s++)t.push(this[e[s]]);db.settings.put(t,DB_KEY_SETTINGS).catch(e=>{console.error(e)})}set(e,t,s){"toggle"===t?this[e]=!this[e]:"incmod"===t?(this[e]++,this[e]%=s):this[e]=t,this.save()}get(e){return this[e]}}