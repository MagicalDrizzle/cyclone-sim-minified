function refreshTracks(e){if(2!==simSettings.trackMode||e)if(tracks.clear(),forecastTracks.clear(),selectedStorm)selectedStorm.renderTrack();else if(2===simSettings.trackMode){let e=UI.viewBasin.getSeason(viewTick),t=t=>t.inBasinTC&&(UI.viewBasin.getSeason(t.enterTime)===e||UI.viewBasin.getSeason(t.enterTime)<e&&(void 0===t.exitTime||UI.viewBasin.getSeason(t.exitTime-1)>=e));for(let e of UI.viewBasin.fetchSeason(viewTick,!0,!0).forSystems())t(e)&&e.renderTrack()}else if(UI.viewBasin.viewingPresent())for(let e of UI.viewBasin.activeSystems)e.fetchStorm().renderTrack();else for(let e of UI.viewBasin.fetchSeason(viewTick,!0,!0).forSystems())e.renderTrack()}function createBuffer(e,t,a,s){e=e||WIDTH,t=t||HEIGHT;let r=createGraphics(e,t),n={baseWidth:e,baseHeight:t,alwaysFull:a,noScale:s};return buffers.set(r,n),r}function rescaleCanvases(e){for(let[t,a]of buffers)a.alwaysFull||(t.resizeCanvas(floor(a.baseWidth*e),floor(a.baseHeight*e)),a.noScale||t.scale(e));resizeCanvas(floor(WIDTH*e),floor(HEIGHT*e))}function toggleFullscreen(){document.fullscreenElement===canvas||deviceOrientation===PORTRAIT?document.exitFullscreen():canvas.requestFullscreen().then(function(){scaler=displayWidth/WIDTH,rescaleCanvases(scaler),UI.viewBasin&&(refreshTracks(!0),UI.viewBasin.env.displayLayer())})}function fullDimensions(){let e=deviceOrientation===PORTRAIT?displayHeight:displayWidth;return{fullW:e,fullH:e*HEIGHT/WIDTH}}function drawBuffer(e){image(e,0,0,WIDTH,HEIGHT)}function getMouseX(){return floor(mouseX/scaler)}function getMouseY(){return floor(mouseY/scaler)}function coordinateInCanvas(e,t,a){return a?e>=0&&e<width&&t>=0&&t<height:e>=0&&e<WIDTH&&t>=0&&t<HEIGHT}function cbrt(e){return e<0?-pow(abs(e),1/3):pow(e,1/3)}function zeroPad(e,t){if(e=parseFloat(e),!Number.isNaN(e)){let a,s=parseInt(e);return a=(a=s<0?"-"+(s=s.toString().slice(1)).padStart(t,"0"):(s=s.toString()).padStart(t,"0")).slice(0,-s.length),a+=abs(e).toString()}}function hashCode(e){let t=0;if(0===e.length)return t;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return t}function loadImg(e){return new Promise((t,a)=>{setTimeout(()=>{loadImage(e,t,a)})})}function waitForAsyncProcess(e,t,...a){waitingFor++,waitingFor<2&&(waitingTCSymbolSHem=random()<.5);let s=waitingDescs.lowestAvailable;s>waitingDescs.maxIndex&&(waitingDescs.maxIndex=s);for(let e=s+1;e<=waitingDescs.maxIndex+1;e++)if(!waitingDescs[e]){waitingDescs.lowestAvailable=e;break}waitingDescs[s]=t;let r=()=>{if(waitingFor--,waitingDescs[s]=void 0,s<waitingDescs.lowestAvailable&&(waitingDescs.lowestAvailable=s),s>=waitingDescs.maxIndex)for(let e=s;e>=-1;e--)if(e<0||waitingDescs[e]){waitingDescs.maxIndex=e;break}},n=e(...a);return n instanceof Promise||n instanceof Dexie.Promise?n.then(e=>(r(),e)).catch(e=>{throw r(),e}):(r(),Promise.resolve(n))}function makeAsyncProcess(e,...t){return new Promise((a,s)=>{setTimeout(()=>{try{a(e(...t))}catch(e){s(e)}})})}function upgradeLegacySaves(){return waitForAsyncProcess(()=>makeAsyncProcess(()=>{let e=LOCALSTORAGE_KEY_PREFIX+"0-",t=LOCALSTORAGE_KEY_PREFIX+LOCALSTORAGE_KEY_SAVEDBASIN+"0-",a=LOCALSTORAGE_KEY_FORMAT,s=LOCALSTORAGE_KEY_BASIN,r=LOCALSTORAGE_KEY_NAMES;localStorage.getItem(e+a)&&(localStorage.setItem(t+a,localStorage.getItem(e+a)),localStorage.removeItem(e+a),localStorage.setItem(t+s,localStorage.getItem(e+s)),localStorage.removeItem(e+s),localStorage.setItem(t+r,localStorage.getItem(e+r)),localStorage.removeItem(e+r))}).then(()=>db.transaction("rw",db.saves,db.seasons,()=>{for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(t.startsWith(LOCALSTORAGE_KEY_PREFIX+LOCALSTORAGE_KEY_SAVEDBASIN)){let e=t.slice((LOCALSTORAGE_KEY_PREFIX+LOCALSTORAGE_KEY_SAVEDBASIN).length);e=e.split("-");let a=parseInt(e[0]);a=0===a?AUTOSAVE_SAVE_NAME:LEGACY_SAVE_NAME_PREFIX+a;let s=LOCALSTORAGE_KEY_PREFIX+LOCALSTORAGE_KEY_SAVEDBASIN+e[0]+"-";if(e[1]===LOCALSTORAGE_KEY_FORMAT){let e={};e.format=parseInt(localStorage.getItem(t),SAVING_RADIX),e.value={},e.value.str=localStorage.getItem(s+LOCALSTORAGE_KEY_BASIN),e.value.names=localStorage.getItem(s+LOCALSTORAGE_KEY_NAMES),db.saves.where(":id").equals(a).count().then(t=>{t<1&&db.saves.put(e,a)})}else if(e[1]+"-"===LOCALSTORAGE_KEY_SEASON){let s;s=""===e[2]?-parseInt(e[3]):parseInt(e[2]);let r={};r.format=FORMAT_WITH_SAVED_SEASONS,r.saveName=a,r.season=s,r.value=localStorage.getItem(t),db.seasons.where("[saveName+season]").equals([a,s]).count().then(e=>{e<1&&db.seasons.put(r)})}}}}).then(()=>{for(let e=localStorage.length-1;e>=0;e--){let t=localStorage.key(e);t.startsWith(LOCALSTORAGE_KEY_PREFIX+LOCALSTORAGE_KEY_SAVEDBASIN)&&localStorage.removeItem(t)}})),"Upgrading...").catch(e=>{console.error(e)})}document.onfullscreenchange=function(){null===document.fullscreenElement&&(scaler=1,rescaleCanvases(scaler),UI.viewBasin&&(refreshTracks(!0),UI.viewBasin.env.displayLayer()))};